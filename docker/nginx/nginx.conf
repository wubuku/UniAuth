user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # 增加缓冲区大小限制，解决 "Request Header Or Cookie Too Large" 错误
    client_header_buffer_size 64k;
    large_client_header_buffers 8 64k;
    client_body_buffer_size 128k;
    client_max_body_size 100m;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript;

    # 前端开发服务器 upstream
    upstream frontend_dev {
        server host.docker.internal:5173;
    }

    # 后端服务 upstream
    upstream backend_service {
        server host.docker.internal:8082;
    }

    # HTTP 服务器 - 统一入口
    server {
        listen 80;
        server_name localhost;

        # 访问日志
        access_log /var/log/nginx/uniauth.access.log main;
        error_log /var/log/nginx/uniauth.error.log warn;

        # ============================================
        # 后端 API 路由 - 优先匹配
        # ============================================

        # 认证服务 API 路由
        location /api/auth {
            proxy_pass http://backend_service/api/auth;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            # 精简：只保留必要的 header，避免请求头过大

            # WebSocket 支持
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # 用户服务 API 路由
        location /api/user {
            proxy_pass http://backend_service/api/user;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # OAuth2 相关路由 - 精简 header 避免 431 错误
        location /oauth2/ {
            proxy_pass http://backend_service/oauth2/;
            proxy_http_version 1.1;
            # 只保留最基本的 header，避免请求头过大
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # H2 数据库控制台（开发环境）
        location /h2-console/ {
            proxy_pass http://backend_service/h2-console/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Swagger UI（后端 API 文档）
        location /swagger-ui/ {
            proxy_pass http://backend_service/swagger-ui/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # OpenAPI v3 文档 JSON
        location /v3/api-docs {
            proxy_pass http://backend_service/v3/api-docs;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # 后端静态资源
        location /static/ {
            proxy_pass http://backend_service/static/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_cache_valid 200 30m;
            add_header Cache-Control "public, max-age=1800";
        }

        # ============================================
        # 前端路由 - 开发服务器代理
        # ============================================

        # Vite HMR WebSocket 支持
        location /@vite/ {
            proxy_pass http://frontend_dev/@vite/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            # WebSocket 支持（Vite HMR 必需）
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400;
        }

        # 前端静态资源（src 目录下的资源）
        location /@fs/ {
            proxy_pass http://frontend_dev/@fs/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 前端 node_modules 资源
        location /@id/ {
            proxy_pass http://frontend_dev/@id/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 前端源文件映射
        location /@src/ {
            proxy_pass http://frontend_dev/@src/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 前端 node_modules 资源（另一种形式）
        location /node_modules/ {
            proxy_pass http://frontend_dev/node_modules/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # ============================================
        # 默认路由 - 前端 SPA 入口
        # ============================================
        location / {
            proxy_pass http://frontend_dev/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # 禁用缓存，确保开发时获取最新内容
            proxy_cache_bypass $http_upgrade;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }
    }
}
