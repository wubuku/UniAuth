# Python ç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬ä½¿ç”¨æŒ‡å—

> **é…å¥—æ–‡æ¡£**: Web3 é’±åŒ…ç™»å½•å®Œæ•´å¼€å‘æŒ‡å—  
> **è„šæœ¬æ–‡ä»¶**: `test_web3_login.py`  
> **ç›®çš„**: åœ¨å¼€å‘å‰ç«¯ä¹‹å‰ï¼Œå…ˆéªŒè¯åç«¯ API æ˜¯å¦æ­£ç¡®å®ç°

---

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªè„šæœ¬ï¼Ÿ

åœ¨å¼€å‘å‰ç«¯ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿åç«¯çš„ Web3 ç™»å½•åŠŸèƒ½å®Œå…¨æ­£å¸¸ã€‚è¿™ä¸ª Python è„šæœ¬å¯ä»¥ï¼š

1. **æ¨¡æ‹Ÿå®Œæ•´çš„ MetaMask ç­¾åæµç¨‹**ï¼ˆæ— éœ€æµè§ˆå™¨ï¼‰
2. **è‡ªåŠ¨åŒ–æµ‹è¯•æ‰€æœ‰ API ç«¯ç‚¹**
3. **éªŒè¯ç­¾åç®—æ³•çš„æ­£ç¡®æ€§**
4. **æ£€æŸ¥ JWT ç”Ÿæˆå’ŒéªŒè¯**
5. **æµ‹è¯• Token åˆ·æ–°æœºåˆ¶**

**ä¸€å¥è¯**: è¿™ä¸ªè„šæœ¬å°±æ˜¯ä¸€ä¸ª **è‡ªåŠ¨åŒ–çš„ MetaMask + å‰ç«¯**ï¼Œç”¨äºéªŒè¯åç«¯ï¼

---

## ğŸ“¦ å®‰è£…ä¾èµ–

```bash
# å®‰è£…å¿…è¦çš„ Python åº“
pip install web3 requests eth-account

# æˆ–ä½¿ç”¨ requirements.txt
cat > requirements.txt << EOF
web3>=6.0.0
requests>=2.31.0
eth-account>=0.10.0
EOF

pip install -r requirements.txt
```

**ä¾èµ–è¯´æ˜**:
- `web3`: ä»¥å¤ªåŠå·¥å…·åº“ï¼ˆç”Ÿæˆé’±åŒ…ã€ç­¾åï¼‰
- `eth-account`: è´¦æˆ·ç®¡ç†ï¼ˆä¸ MetaMask ç­¾åæ–¹å¼ä¸€è‡´ï¼‰
- `requests`: HTTP å®¢æˆ·ç«¯ï¼ˆè°ƒç”¨åç«¯ APIï¼‰

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# 1. ç¡®ä¿åç«¯å·²å¯åŠ¨
mvn spring-boot:run

# 2. åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œæµ‹è¯•è„šæœ¬
python test_web3_login.py
```

### é«˜çº§ç”¨æ³•

```bash
# æŒ‡å®šåç«¯ URLï¼ˆå¦‚æœä¸æ˜¯ localhost:8080ï¼‰
python test_web3_login.py --url http://192.168.1.100:8080

# ä½¿ç”¨ç°æœ‰ç§é’¥æµ‹è¯•ï¼ˆç”¨äºé‡å¤æµ‹è¯•åŒä¸€è´¦æˆ·ï¼‰
python test_web3_login.py --private-key 0x1234567890abcdef...

# ç®€åŒ–è¾“å‡ºï¼ˆåªæ˜¾ç¤ºå…³é”®ä¿¡æ¯ï¼‰
python test_web3_login.py --quiet

# æŸ¥çœ‹å¸®åŠ©
python test_web3_login.py --help
```

---

## ğŸ“Š æµ‹è¯•æµç¨‹è¯¦è§£

### å®Œæ•´æµ‹è¯•æ­¥éª¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1: åˆ›å»ºæµ‹è¯•é’±åŒ…                                         â”‚
â”‚  - ç”Ÿæˆéšæœºç§é’¥                                              â”‚
â”‚  - è®¡ç®—é’±åŒ…åœ°å€                                              â”‚
â”‚  è¾“å‡º: 0x5cE9454909639D2D17A3F753ce7d93fa0b9aB12E          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2: è·å– Nonce                                          â”‚
â”‚  GET /api/auth/web3/nonce/{walletAddress}                   â”‚
â”‚  âœ… éªŒè¯: å“åº”åŒ…å« nonce å’Œ message                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3: ç­¾åæ¶ˆæ¯ï¼ˆæ¨¡æ‹Ÿ MetaMaskï¼‰                            â”‚
â”‚  - ä½¿ç”¨ eth-account åº“ç­¾å                                   â”‚
â”‚  - æ·»åŠ ä»¥å¤ªåŠå‰ç¼€: "\x19Ethereum Signed Message:\n{len}"    â”‚
â”‚  - æœ¬åœ°éªŒè¯ç­¾åï¼ˆæ¢å¤åœ°å€å¹¶æ¯”å¯¹ï¼‰                              â”‚
â”‚  âœ… éªŒè¯: æ¢å¤çš„åœ°å€ == é’±åŒ…åœ°å€                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 4: æäº¤ç­¾åéªŒè¯                                         â”‚
â”‚  POST /api/auth/web3/verify                                 â”‚
â”‚  Body: {walletAddress, message, signature, nonce}           â”‚
â”‚  âœ… éªŒè¯: å“åº”åŒ…å« accessToken å’Œ refreshToken               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 5: æµ‹è¯•å—ä¿æŠ¤çš„ API                                     â”‚
â”‚  GET /api/user/profile                                      â”‚
â”‚  Header: Authorization: Bearer {accessToken}                â”‚
â”‚  âœ… éªŒè¯: è¿”å› 200 æˆ– 401ï¼ˆå–å†³äºåç«¯æ˜¯å¦å®ç°è¯¥ç«¯ç‚¹ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 6: åˆ·æ–° Token                                          â”‚
â”‚  POST /api/auth/web3/refresh                                â”‚
â”‚  Header: Authorization: Bearer {refreshToken}               â”‚
â”‚  âœ… éªŒè¯: è¿”å›æ–°çš„ accessToken                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æˆåŠŸè¾“å‡ºç¤ºä¾‹

```
======================================================================
          Web3 é’±åŒ…ç™»å½•ç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬
======================================================================

â„¹ï¸  åç«¯ URL: http://localhost:8080
â„¹ï¸  å¼€å§‹æµ‹è¯•...

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â„¹ï¸  ã€æµ‹è¯• 1ã€‘å®Œæ•´çš„ Web3 é’±åŒ…ç™»å½•æµç¨‹

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

============================================================
æ­¥éª¤ 1: åˆ›å»ºæµ‹è¯•é’±åŒ…
============================================================

âœ… é’±åŒ…åˆ›å»ºæˆåŠŸ
  é’±åŒ…åœ°å€: 0x5cE9454909639D2D17A3F753ce7d93fa0b9aB12E
  ç§é’¥: 0xb25c7db31feed9122727bf0939dc769a96564b2de4c4726d035b36ecf1e5b364

============================================================
æ­¥éª¤ 2: ä»åç«¯è·å– Nonce
============================================================

  è¯·æ±‚ URL: http://localhost:8080/api/auth/web3/nonce/0x5cE9454909639D2D17A3F753ce7d93fa0b9aB12E
âœ… Nonce è·å–æˆåŠŸ
  Nonce: a1b2c3d4e5f6789012345678
  å¾…ç­¾åæ¶ˆæ¯: example.com wants you to sign in with your Ethereum account:
0x5cE9454909639D2D17A3F753ce7d93fa0b9aB12E

By signing, you agree to authenticate with your wallet.

URI: https://example.com
Version: 1
Chain ID: 1
Nonce: a1b2c3d4e5f6789012345678
Issued At: 2026-02-04T02:15:30.123456Z
Expiration Time: 2026-02-04T02:20:30.123456Z

============================================================
æ­¥éª¤ 3: ç­¾åæ¶ˆæ¯ï¼ˆæ¨¡æ‹Ÿ MetaMaskï¼‰
============================================================

âœ… æ¶ˆæ¯ç­¾åå®Œæˆ
  ç­¾åç»“æœ: 0xe6ca9bba58c88611fad66a6ce8f996908195593807c4b38bd528d2cff09d4eb33e5bfbbf4d3e39b1a2fd816a7680c19ebebaf3a141b239934ad43cb33fcec8ce1c
  æ¶ˆæ¯å“ˆå¸Œ: 0x1476abb745d423bf09273f1afd887d951181d25adc66c4834a70491911b7f750
  æ¢å¤çš„åœ°å€: 0x5ce9454909639d2d17a3f753ce7d93fa0b9ab12e
âœ… ç­¾åéªŒè¯é€šè¿‡ï¼ˆæœ¬åœ°éªŒè¯ï¼‰

============================================================
æ­¥éª¤ 4: æäº¤ç­¾ååˆ°åç«¯éªŒè¯
============================================================

  è¯·æ±‚ URL: http://localhost:8080/api/auth/web3/verify
âœ… ç™»å½•éªŒè¯æˆåŠŸï¼
  Access Token: eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiIweDVjZTk0NTQ5MDk2MzlkMmQxN2EzZjc1M2NlN2Q5M2ZhMGI5YWIxMmUiLCJpYXQiOjE3MDczNzAxMzAsImV4cCI6MTcwNzM3MTAzMH0...
  Refresh Token: eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiIweDVjZTk0NTQ5MDk2MzlkMmQxN2EzZjc1M2NlN2Q5M2ZhMGI5YWIxMmUiLCJpYXQiOjE3MDczNzAxMzAsImV4cCI6MTcwNzk3NDkzMH0...
  Token ç±»å‹: Bearer
  è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰: 900
  é’±åŒ…åœ°å€: 0x5ce9454909639d2d17a3f753ce7d93fa0b9ab12e

âœ… å®Œæ•´ç™»å½•æµç¨‹æµ‹è¯•é€šè¿‡ï¼

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â„¹ï¸  ã€æµ‹è¯• 2ã€‘è®¿é—®å—ä¿æŠ¤çš„ API

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

============================================================
æ­¥éª¤ 5: æµ‹è¯•å—ä¿æŠ¤çš„ API: /api/user/profile
============================================================

  è¯·æ±‚ URL: http://localhost:8080/api/user/profile
  Authorization å¤´: Bearer eyJhbGciOiJIUzUxMi...
  å“åº”çŠ¶æ€ç : 404
  å“åº”å†…å®¹: {"timestamp":"2026-02-04T02:15:35.123+00:00","status":404,"error":"Not Found","path":"/api/user/profile"}
âš ï¸  API ç«¯ç‚¹ä¸å­˜åœ¨ï¼ˆ404ï¼‰- æ­£å¸¸ï¼Œæµ‹è¯•åç«¯çš„

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â„¹ï¸  ã€æµ‹è¯• 3ã€‘åˆ·æ–° Access Token

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

============================================================
æ­¥éª¤ 6: åˆ·æ–° Access Token
============================================================

  è¯·æ±‚ URL: http://localhost:8080/api/auth/web3/refresh
  Authorization å¤´: Bearer eyJhbGciOiJIUzUxMi...
âœ… Token åˆ·æ–°æˆåŠŸ
  æ—§ Access Token: eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiIweDVjZTk0NTQ5...
  æ–° Access Token: eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiIweDVjZTk0NTQ5...
  è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰: 900

======================================================================
                    æµ‹è¯•å®Œæˆï¼
======================================================================

âœ… âœ… æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡
â„¹ï¸  é’±åŒ…åœ°å€: 0x5cE9454909639D2D17A3F753ce7d93fa0b9aB12E
â„¹ï¸  Access Token: eyJhbGciOiJIUzUxMiJ9.eyJzdWIi...

ğŸ’¡ æç¤º:
  - æ‚¨å¯ä»¥åœ¨ MySQL ä¸­æŸ¥è¯¢ç”¨æˆ·è¡¨éªŒè¯æ•°æ®
  - æ‚¨å¯ä»¥åœ¨ Redis ä¸­æŸ¥çœ‹ nonce çš„å­˜å‚¨ï¼ˆåº”è¯¥å·²è¢«åˆ é™¤ï¼‰
  - Access Token æœ‰æ•ˆæœŸ 15 åˆ†é’Ÿï¼ŒRefresh Token æœ‰æ•ˆæœŸ 7 å¤©
```

---

## âœ… éªŒè¯æ¸…å•

æµ‹è¯•è„šæœ¬è¿è¡ŒæˆåŠŸåï¼Œè¯·éªŒè¯ä»¥ä¸‹å†…å®¹ï¼š

### 1. MySQL æ•°æ®åº“

```sql
-- æŸ¥çœ‹ç”¨æˆ·è¡¨
SELECT * FROM users ORDER BY id DESC LIMIT 5;

-- åº”è¯¥çœ‹åˆ°æ–°åˆ›å»ºçš„ç”¨æˆ·è®°å½•
-- wallet_address: 0x5ce9454909639d2d17a3f753ce7d93fa0b9ab12e (å°å†™)
-- chain_id: 1
-- status: 1
-- created_at: å½“å‰æ—¶é—´
-- last_login_at: å½“å‰æ—¶é—´
```

### 2. Redis å­˜å‚¨

```bash
# è¿æ¥ Redis
redis-cli

# æŸ¥çœ‹ nonceï¼ˆåº”è¯¥æ˜¯ç©ºçš„ï¼Œå› ä¸ºéªŒè¯åè¢«åˆ é™¤ï¼‰
> keys web3:nonce:*
(empty list or set)

# å¦‚æœæ˜¾ç¤ºæœ‰ keyï¼Œè¯´æ˜éªŒè¯è¿‡ç¨‹æœ‰é—®é¢˜
```

### 3. æ—¥å¿—æ–‡ä»¶

æ£€æŸ¥ Spring Boot æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
INFO  - ä¸ºåœ°å€ 0x5ce9454909639d2d17a3f753ce7d93fa0b9ab12e ç”Ÿæˆ nonce: a1b2c3d4...
INFO  - ç­¾åéªŒè¯æˆåŠŸ: 0x5ce9454909639d2d17a3f753ce7d93fa0b9ab12e
INFO  - åˆ›å»ºæ–°ç”¨æˆ·: 0x5ce9454909639d2d17a3f753ce7d93fa0b9ab12e
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: è¿æ¥åç«¯å¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
âŒ è·å– nonce å¤±è´¥: Connection refused
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨
curl http://localhost:8080/actuator/health

# 2. æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£ç¡®
netstat -an | grep 8080

# 3. å¦‚æœåç«¯åœ¨å…¶ä»–åœ°å€ï¼Œä½¿ç”¨ --url å‚æ•°
python test_web3_login.py --url http://192.168.1.100:8080
```

### é—®é¢˜ 2: ç­¾åéªŒè¯å¤±è´¥

**é”™è¯¯ä¿¡æ¯**:
```
âŒ ç™»å½•éªŒè¯å¤±è´¥: 400 Bad Request
å“åº”å†…å®¹: ç­¾åéªŒè¯å¤±è´¥
```

**å¯èƒ½åŸå› **:
1. **æ¶ˆæ¯æ ¼å¼ä¸ä¸€è‡´**: æ£€æŸ¥åç«¯ `buildSiweMessage` æ–¹æ³•çš„è¾“å‡º
2. **ç­¾åç®—æ³•ä¸åŒ¹é…**: ç¡®ä¿åç«¯ä½¿ç”¨ Web3j çš„ `Sign.recoverFromSignature`
3. **åœ°å€å¤§å°å†™é—®é¢˜**: ç¡®ä¿åç«¯ç»Ÿä¸€è½¬ä¸ºå°å†™

**è°ƒè¯•æ–¹æ³•**:
```bash
# è¿è¡Œè„šæœ¬æ—¶æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
python test_web3_login.py

# å¯¹æ¯”å‰åç«¯çš„æ¶ˆæ¯æ ¼å¼
# Python ç”Ÿæˆçš„æ¶ˆæ¯:
#   example.com wants you to sign in with your Ethereum account:
#   0x5cE9454909639D2D17A3F753ce7d93fa0b9aB12E
#   ...

# åç«¯ç”Ÿæˆçš„æ¶ˆæ¯åº”è¯¥å®Œå…¨ä¸€è‡´
```

### é—®é¢˜ 3: JWT è§£æé”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
âŒ Token åˆ·æ–°å¤±è´¥: 500 Internal Server Error
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ JWT secret é…ç½®
# 1. ç¡®ä¿ application.yml ä¸­çš„ jwt.secret è‡³å°‘ 64 å­—èŠ‚
# 2. ç”Ÿæˆæ–°çš„ secret
openssl rand -base64 64

# 3. æ›´æ–°é…ç½®æ–‡ä»¶
jwt:
  secret: <æ–°ç”Ÿæˆçš„ secret>
```

### é—®é¢˜ 4: Nonce è¿‡æœŸ

**é”™è¯¯ä¿¡æ¯**:
```
âŒ ç™»å½•éªŒè¯å¤±è´¥: Nonce æ— æ•ˆæˆ–å·²è¿‡æœŸ
```

**è§£å†³æ–¹æ¡ˆ**:
- Nonce æœ‰æ•ˆæœŸé»˜è®¤ 5 åˆ†é’Ÿ
- å¦‚æœæµ‹è¯•æ—¶é—´è¿‡é•¿ï¼Œé‡æ–°è¿è¡Œè„šæœ¬
- è°ƒæ•´ `application.yml` ä¸­çš„ `web3.nonce-expiration` é…ç½®

---

## ğŸ”§ è‡ªå®šä¹‰æµ‹è¯•

### æµ‹è¯•ç‰¹å®šåœºæ™¯

```python
from test_web3_login import Web3WalletTester

# åˆ›å»ºæµ‹è¯•å™¨
tester = Web3WalletTester("http://localhost:8080")

# åœºæ™¯ 1: æµ‹è¯•é”™è¯¯çš„ç­¾å
tester.create_test_wallet()
nonce, message = tester.get_nonce()
fake_signature = "0x" + "0" * 130  # ä¼ªé€ çš„ç­¾å
try:
    tester.verify_and_login(message, fake_signature, nonce)
except Exception as e:
    print("âœ… æ­£ç¡®æ‹’ç»äº†ä¼ªé€ ç­¾å")

# åœºæ™¯ 2: æµ‹è¯•é‡æ”¾æ”»å‡»ï¼ˆä½¿ç”¨åŒä¸€ä¸ª nonceï¼‰
tester.create_test_wallet()
nonce, message = tester.get_nonce()
signature = tester.sign_message(message)
tester.verify_and_login(message, signature, nonce)
# ç¬¬äºŒæ¬¡ä½¿ç”¨ç›¸åŒ nonce åº”è¯¥å¤±è´¥
try:
    tester.verify_and_login(message, signature, nonce)
except Exception as e:
    print("âœ… æ­£ç¡®é˜²æ­¢äº†é‡æ”¾æ”»å‡»")

# åœºæ™¯ 3: æµ‹è¯•è¿‡æœŸçš„ Token
import time
tester.complete_login_flow()
old_token = tester.access_token
time.sleep(901)  # ç­‰å¾… Token è¿‡æœŸï¼ˆ15 åˆ†é’Ÿ + 1 ç§’ï¼‰
# ä½¿ç”¨è¿‡æœŸ Token åº”è¯¥å¤±è´¥
```

---

## ğŸ“š è„šæœ¬ä»£ç è§£æ

### æ ¸å¿ƒç­¾åé€»è¾‘

Python è„šæœ¬ä¸­çš„ç­¾åè¿‡ç¨‹ä¸ MetaMask å®Œå…¨ä¸€è‡´ï¼š

```python
from eth_account import Account
from eth_account.messages import encode_defunct

# 1. ç¼–ç æ¶ˆæ¯ï¼ˆè‡ªåŠ¨æ·»åŠ ä»¥å¤ªåŠå‰ç¼€ï¼‰
message = "example.com wants you to sign in..."
encoded_message = encode_defunct(text=message)
# å†…éƒ¨ä¼šæ·»åŠ : "\x19Ethereum Signed Message:\n" + len(message)

# 2. ç­¾å
account = Account.from_key(private_key)
signed_message = account.sign_message(encoded_message)

# 3. è·å–ç­¾åç»“æœ
signature = signed_message.signature.hex()  # 0x å¼€å¤´çš„ 130 å­—ç¬¦

# 4. éªŒè¯ç­¾åï¼ˆå¯é€‰ï¼‰
recovered_address = Account.recover_message(encoded_message, signature=signature)
assert recovered_address.lower() == wallet_address.lower()
```

### åç«¯éªŒè¯é€»è¾‘å¯¹æ¯”

**Python (æµ‹è¯•è„šæœ¬)**:
```python
encoded_message = encode_defunct(text=message)
recovered_address = Account.recover_message(encoded_message, signature=signature)
```

**Java (åç«¯)**:
```java
String prefix = "\u0019Ethereum Signed Message:\n" + message.length();
byte[] msgHash = Hash.sha3((prefix + message).getBytes(StandardCharsets.UTF_8));
BigInteger publicKey = Sign.recoverFromSignature(recId, signatureData, msgHash);
String address = "0x" + Keys.getAddress(publicKey);
```

ä¸¤è€…åº”è¯¥äº§ç”Ÿç›¸åŒçš„ç»“æœï¼

---

## ğŸ“ å­¦ä¹ èµ„æº

- **eth-account æ–‡æ¡£**: https://eth-account.readthedocs.io
- **Web3.py æ–‡æ¡£**: https://web3py.readthedocs.io
- **ä»¥å¤ªåŠç­¾åæ ‡å‡†**: https://eips.ethereum.org/EIPS/eip-191
- **SIWE æ ‡å‡†**: https://eips.ethereum.org/EIPS/eip-4361

---

## ğŸ“ æ”¯æŒ

å¦‚æœæµ‹è¯•è„šæœ¬è¿è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š

1. âœ… åç«¯æ˜¯å¦æ­£ç¡®å¯åŠ¨ï¼ˆç«¯å£ 8080ï¼‰
2. âœ… Redis æ˜¯å¦è¿è¡Œï¼ˆç«¯å£ 6379ï¼‰
3. âœ… MySQL æ˜¯å¦è¿æ¥æˆåŠŸ
4. âœ… ä¾èµ–åŒ…æ˜¯å¦æ­£ç¡®å®‰è£…ï¼ˆ`pip list | grep web3`ï¼‰

**æˆåŠŸçš„æ ‡å¿—**: çœ‹åˆ°ç»¿è‰²çš„ âœ… å’Œ "æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡" æ¶ˆæ¯ï¼

---

**ğŸ‰ æµ‹è¯•é€šè¿‡åï¼Œå°±å¯ä»¥æ”¾å¿ƒå¼€å‘å‰ç«¯äº†ï¼åç«¯å·²ç» 100% éªŒè¯å¯ç”¨ï¼**
